---
title: "2_Evaluations"
output: html_document
date: "2025-10-13"
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, root.dir='/Users/lkt38/Documents/Github/Alf-IWG_Selection')
```

```{r}
library(MASS)
library(corrplot)
library(dplyr)
library(tidyr)
library(ggplot2)
install.packages("irr")
library(irr)
install.packages("metan")
library(metan)
```

Make sure data is normal

```{r}
data <- read.csv('data/Intermediate/data_shared_across_locations.csv')
```

Histograms - Check Normality and Transform

```{r}
colnames(data)

hist(data$Emergence_Stand_count) # left skewed

hist(data$Emergence_Alfalfa_Height) # not normal
hist(log(data$Emergence_Alfalfa_Height)) # bimodal

hist(data$First_Summer_Alfalfa_Height) # bimodal
hist(log(data$First_Summer_Alfalfa_Height)) # bimodal

hist(data$First_Summer_IWG_Height) # outliers
hist(log(data$First_Summer_IWG_Height))

hist(data$First_Summer_Maturity)

hist(data$First_Summer_Alfalfa_Stand_count) # left skewed

hist(data$First_Summer_Lodging) # right skewed
hist(log(data$First_Summer_Lodging)) # uniform

hist(data$First_Yr_Regrowth_Vigor)

hist(data$First_Summer_ALF_Biomass) # right skewed 
hist(sqrt(data$First_Summer_ALF_Biomass))

hist(data$First_Summer_IWG_Biomass) # outlier
hist(log(data$First_Summer_IWG_Biomass))

hist(data$First_Summer_Grain_Biomass)

```

```{r}
data$First_Summer_IWG_Height_log <- log(data$First_Summer_IWG_Height)
data$First_Summer_ALF_Biomass_sqrt <- sqrt(data$First_Summer_ALF_Biomass)
data$First_Summer_IWG_Biomass_log <- log(data$First_Summer_IWG_Biomass)

# make data frame of normal values
data2 <- data[,c('LOC', 'Entry', 'Rep', 'selected', 'selection_location', 'First_Summer_IWG_Height_log', 'First_Summer_Maturity', 'First_Yr_Regrowth_Vigor', 'First_Summer_ALF_Biomass_sqrt', 'First_Summer_IWG_Biomass_log', 'First_Summer_Lodging')]
```

Correlation 

```{r}
correlations = cor(data2[,c(6:ncol(data2))], use = "pairwise.complete.obs")
corrplot.mixed(correlations, order = 'AOE')
## leave blank on non-significant coefficient
## add significant correlation coefficients
testRes = cor.mtest(data2[,c(6:ncol(data2))], conf.level = 0.95)
corrplot(correlations, p.mat = testRes$p, method = 'circle', type = 'lower', insig='blank',
         addCoef.col ='black', number.cex = 0.8, order = 'AOE', diag=FALSE)
```

Stability or consistency of performance across environments

```{r}
# average entry value per location
entry_means <- data2 %>%
  group_by(LOC, Entry) %>%
  summarise(mean_biomass = mean(First_Summer_ALF_Biomass_sqrt, na.rm = TRUE)) %>%
  ungroup()

# rank entries per location
ranked <- entry_means %>%
  group_by(LOC) %>%
  mutate(rank = rank(-mean_biomass, ties.method = "average")) %>%
  ungroup()

rank_wide <- ranked %>%
  select(LOC, Entry, rank) %>%
  pivot_wider(names_from = LOC, values_from = rank)
```

```{r}
# Overall stability (mean and sd)
rank_summary <- rank_wide %>%
  mutate(mean_rank = rowMeans(across(starts_with("LOC")), na.rm = TRUE),
         sd_rank = apply(across(starts_with("LOC")), 1, sd, na.rm = TRUE)) %>%
  arrange(mean_rank)

```

```{r}
# pairwise rank correlation 
cor(rank_wide$WI, rank_wide$NY, method = "spearman", use = "pairwise.complete.obs")
cor(rank_wide$WI, rank_wide$KS, method = "spearman", use = "pairwise.complete.obs")
cor(rank_wide$NY, rank_wide$KS, method = "spearman", use = "pairwise.complete.obs")
```

```{r}
# Select rank columns
rank_matrix <- rank_wide %>%
  select(WI, NY, KS)

# Kendall’s W
kendall(rank_matrix)
# W = relative agreement (0-1)
# pval = is observed agreement significantly greater than expected by chance
```

Visualize GxE

```{r}
# GGE biplot to visualize genotype × environment (G×E) interaction and identify which genotypes perform best in which environments
means_wide <- entry_means %>%
  select(LOC, Entry, mean_biomass) %>%
  pivot_wider(names_from = LOC, values_from = mean_biomass)

gge_model <- gge(entry_means, env = LOC, gen = Entry, resp = mean_biomass)
plot(gge_model, type = 1, size.lab.gen = 3,   # smaller label size
     max.overlaps = 15000, # allow more overlaps
     repel = TRUE)   # which-won-where
```

```{r}
# visual of rankings
ggplot(ranked, aes(x = LOC, y = rank, group = Entry, color = Entry)) +
  geom_line() +
  geom_point() +
  scale_y_reverse() +  # rank 1 at top
  theme_minimal() +
  labs(title = "Alfalfa Entry rankings across locations",
       y = "Rank (1 = highest biomass)")
```

```{r}
write.csv(data2, 'data/Intermediate/data_shared_across_locations_transformed.csv')
```